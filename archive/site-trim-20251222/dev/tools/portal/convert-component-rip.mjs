#!/usr/bin/env node
/**
 * Component Rip Conversion Helper (scaffold)
 *
 * Goal:
 *  - Take a raw HTML export from archive/component-rips-20251112/Component_Rips
 *  - Produce packages/component-rips/<slug>/{index.html, styles.css, script.js, meta.json}
 *  - Strip Framer analytics, badges, external script tags, and MiniMotion globals.
 *  - Ensure autoplay media is disabled; audio/video start paused & muted until activated.
 *
 * This is a scaffold to outline the workflow.
 */

import { promises as fs } from "node:fs";
import path from "node:path";
import url from "node:url";

const __dirname = path.dirname(url.fileURLToPath(import.meta.url));
const projectRoot = path.resolve(__dirname, "../..");

async function main() {
  const [sourcePath, targetSlug] = process.argv.slice(2);

  if (!sourcePath || !targetSlug) {
    console.error("Usage: convert-component-rip.mjs <source-html> <target-slug>");
    process.exit(1);
  }

  const absoluteSource = path.resolve(projectRoot, sourcePath);
  const outputDir = path.join(projectRoot, "packages", "component-rips", targetSlug);

  await fs.mkdir(outputDir, { recursive: true });

  const html = await fs.readFile(absoluteSource, "utf8");

  // TODO: parse HTML, extract inline CSS/JS, remove external scripts, sanitize autoplay media.
  const placeholderHtml = `<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>${targetSlug}</title>
    <link rel="stylesheet" href="./styles.css">
  </head>
  <body>
    <div id="component-root"></div>
    <script type="module" src="./script.js"></script>
  </body>
</html>
`;

  const meta = {
    name: targetSlug.replace(/[-_]/g, " ").replace(/\b\w/g, (char) => char.toUpperCase()),
    slug: targetSlug,
    category: "unknown",
    status: "scaffold",
    description: "Autogenerated scaffold. Replace with real component description.",
    source: path.relative(projectRoot, absoluteSource),
    convertedAt: new Date().toISOString(),
    tags: [],
    safety: {
      audio: false,
      video: false,
      camera: false,
      notes: "Review required. Confirm no autoplay media before promoting.",
    },
    controls: [],
  };

  await Promise.all([
    fs.writeFile(path.join(outputDir, "index.html"), placeholderHtml, "utf8"),
    fs.writeFile(path.join(outputDir, "styles.css"), "/* TODO: extracted styles */\n", "utf8"),
    fs.writeFile(
      path.join(outputDir, "script.js"),
      `console.warn("[component-rip] ${targetSlug}: script extraction pending");\n`,
      "utf8"
    ),
    fs.writeFile(path.join(outputDir, "meta.json"), `${JSON.stringify(meta, null, 2)}\n`, "utf8"),
  ]);

  console.log(`Scaffold created at ${outputDir}`);
  console.log("Reminder: replace placeholder files with parsed content.");
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});

