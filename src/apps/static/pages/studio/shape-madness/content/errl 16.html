<!doctype html>
<html lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Offscreen Knots (Worker)</title>
<style>
:root{ --bg:#050816; --ink:#eaf7ff; --edge:#1b2656 }
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui}
.wrap{min-height:100dvh;display:grid;place-items:center}
.stage{position:relative;width:min(92vw,900px);aspect-ratio:16/10;border:1px solid var(--edge);border-radius:14px;overflow:hidden;background:#040a1c}
canvas{width:100%;height:100%}
.ui{position:absolute;inset:auto 10px 10px 10px;display:flex;gap:8px;flex-wrap:wrap}
.btn{cursor:pointer;background:#141a3c;border:1px solid #29336b;color:#dff5ff;font-size:12px;padding:6px 10px;border-radius:8px}
.btn:hover{border-color:#46a8ff}
</style></head><body>
<div class="wrap">
  <div class="stage">
    <canvas id="view" width="1100" height="688"></canvas>
    <div class="ui"><button class="btn" id="mut">Mutate</button></div>
  </div>
</div>
<script>
const canvas = document.getElementById('view');
const workerCode = `
let c, x, W, H, T=0;
let params = {R:120, r:31, d:48, ax:7, ay:5, hue:0};
self.onmessage = (e)=>{
  if(e.data.type==='init'){
    c = e.data.canvas; W=e.data.w; H=e.data.h; T=0; x=c.getContext('2d'); render();
  }else if(e.data.type==='mutate'){
    params.R = 80 + Math.random()*120;
    params.r = 17 + Math.random()*34;
    params.d = 28 + Math.random()*60;
    params.ax = 3 + Math.floor(Math.random()*8);
    params.ay = 3 + Math.floor(Math.random()*8);
  }else if(e.data.type==='resize'){
    W=e.data.w; H=e.data.h;
  }
}
function render(){
  T++;
  x.fillStyle="rgba(5,8,22,0.07)"; x.fillRect(0,0,W,H);
  x.beginPath(); x.lineWidth=1.2; x.strokeStyle="hsl("+( (params.hue+=0.7)%360 )+" 95% 70%)";
  const cx=W/2, cy=H/2;
  for(let i=0;i<=1200;i++){
    const u=i/1200*Math.PI*2*9 + T*0.012;
    const sx=(params.R-params.r)*Math.cos(u)+params.d*Math.cos(((params.R-params.r)/params.r)*u);
    const sy=(params.R-params.r)*Math.sin(u)-params.d*Math.sin(((params.R-params.r)/params.r)*u);
    const lx=(cx + sx*1.0) + Math.sin(params.ax*u)*16;
    const ly=(cy + sy*0.9) + Math.sin(params.ay*u + Math.PI/3)*14;
    if(i===0) x.moveTo(lx,ly); else x.lineTo(lx,ly);
  }
  x.stroke();
  requestAnimationFrame(render);
}
`;
const blob = new Blob([workerCode], {type:'application/javascript'});
const worker = new Worker(URL.createObjectURL(blob), {type:'module'});

// Offscreen canvas transfer
const off = canvas.transferControlToOffscreen();
worker.postMessage({type:'init', canvas: off, w: canvas.width, h: canvas.height}, [off]);

// Mutate button
document.getElementById('mut').onclick=()=>worker.postMessage({type:'mutate'});

// Resize (optional)
addEventListener('resize', ()=>{
  const dpr = Math.max(1, devicePixelRatio||1);
  const rect = canvas.getBoundingClientRect();
  const w = Math.floor(rect.width*dpr), h = Math.floor(rect.height*dpr);
  // mirror dims to worker (no need to set width/height on view after transfer)
  worker.postMessage({type:'resize', w, h});
});
</script>
</body></html>