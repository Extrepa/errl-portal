<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Errl Dev Controls</title>
  <style>
    :root{ --ink:#e5eaf1; --bg:#0a0f18; --line:#ffffff22; --teal:#00e5ff; }
    html,body{height:100%;margin:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink);}
    .wrap{ max-width:920px; margin:32px auto; padding:0 16px; }
    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
    h1{ font-size:18px; margin:0; letter-spacing:.02em; }
    .card{ background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:16px; margin:12px 0; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button, a.btn{ background:#1a2340; color:#eaf6ff; border:1px solid #2a3a6a; border-radius:10px; padding:8px 12px; cursor:pointer; text-decoration:none; }
    button:hover, a.btn:hover{ background:#213056; }
    code{ background:rgba(255,255,255,.06); padding:2px 6px; border-radius:6px; }
    .muted{ opacity:.8; }
    .kv{ display:grid; grid-template-columns: 160px 1fr; gap:6px 12px; }
    .kv div{ padding:4px 0; border-bottom:1px dashed rgba(255,255,255,.1); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üéÆ Errl Dev Controls</h1>
      <a id="backToTarget" class="btn" href="#">Back to Target</a>
    </header>

    <div class="card">
      <div class="row">
        <button id="openWithDev">Open Target with Dev Panel (?dev=true)</button>
        <button id="exitDev">Exit Dev Mode on Target</button>
        <button id="clearAll">Clear All Persisted Settings</button>
      </div>
      <p class="muted" style="margin-top:8px;">Master controls here are persistent (saved). The in-page Errl phone is for temporary tweaks.</p>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Target</h3>
      <div class="kv">
        <div>URL</div>
        <div id="targetUrl"></div>
        <div>Current</div>
        <div><code id="currentUrl"></code></div>
      </div>
    </div>

    <div class="card" id="livePanel">
      <h3 style="margin-top:0">Live Controls (Embedded Target)</h3>
      <div class="row" style="margin-bottom:8px; gap:10px;">
        <button id="embedTarget">Embed Target</button>
        <button id="toggleDevPanel">Toggle Dev Panel</button>
        <button id="iframeExitDev">Exit Dev Mode (iframe)</button>
        <button id="snapshotState" style="margin-left:auto;">Snapshot From Embedded</button>
        <button id="applyState">Apply To Embedded</button>
      </div>

      <h4>Hue</h4>
      <div class="row" style="margin-bottom:6px; gap:10px; align-items:flex-end;">
        <label>Target
          <select id="hueTarget" style="margin-left:6px;">
            <option value="nav">Nav</option>
            <option value="errl">Errl</option>
            <option value="glOverlay">Overlay</option>
            <option value="backGlow">Back Glow</option>
            <option value="bgBubbles">Bubbles</option>
          </select>
        </label>
        <label style="margin-left:auto;">
          <input type="checkbox" id="hueEnabled" checked /> Enabled
        </label>
      </div>
      <div class="row">
        <label>Hue <input id="hue" type="range" min="0" max="360" step="1" value="0"/></label>
        <label>Saturation <input id="sat" type="range" min="0" max="2" step="0.01" value="1"/></label>
        <label>Intensity <input id="inten" type="range" min="0" max="1" step="0.01" value="1"/></label>
        <label>Theme
          <select id="theme">
            <option value="normal">Normal</option>
            <option value="warm">Warm</option>
            <option value="cool">Cool</option>
            <option value="electric">Electric</option>
            <option value="sunset">Sunset</option>
            <option value="ocean">Ocean</option>
            <option value="forest">Forest</option>
          </select>
        </label>
      </div>

      <h4>Errl Goo</h4>
      <div class="row">
        <label><input type="checkbox" id="errlGooEnabled"/> Enabled</label>
        <label>Strength <input id="errlGooMult" type="range" min="0" max="2" step="0.01" value="1"/></label>
        <label>Wobble <input id="errlGooWobble" type="range" min="0" max="2" step="0.01" value="1"/></label>
      </div>

      <h4>Nav Goo</h4>
      <div class="row">
        <label><input type="checkbox" id="navGooEnabled"/> Enabled</label>
        <label>Blur <input id="navGooBlur" type="range" min="0" max="16" step="0.1" value="6"/></label>
        <label>Intensity <input id="navGooMult" type="range" min="6" max="40" step="1" value="24"/></label>
        <label>Threshold <input id="navGooThresh" type="range" min="-30" max="-1" step="1" value="-14"/></label>
      </div>

      <h4>GL Overlay</h4>
      <div class="row">
        <label>Alpha <input id="glAlphaCtl" type="range" min="0" max="1" step="0.01" value="0.20"/></label>
        <label>Disp X <input id="glDXCtl" type="range" min="0" max="64" step="1" value="24"/></label>
        <label>Disp Y <input id="glDYCtl" type="range" min="0" max="64" step="1" value="18"/></label>
      </div>

      <h4>Nav Layout</h4>
      <div class="row">
        <label>Spread <input id="navSpreadCtl" type="range" min="80" max="360" step="1" value="220"/></label>
        <label>Arc <input id="navArcCtl" type="range" min="40" max="180" step="1" value="120"/></label>
        <label>Head Y% <input id="navHeadYCtl" type="range" min="0.20" max="0.45" step="0.005" value="0.32"/></label>
        <label>Center X <input id="navCxCtl" type="range" min="-600" max="600" step="1" value="-280"/></label>
        <label>Stagger <input id="navStaggerCtl" type="number" min="0" step="50" value="250"/></label>
      </div>

      <h4>Bubbles FX</h4>
      <div class="row">
        <label>Speed <input id="bubSpeed" type="range" min="0" max="2" step="0.01" value="1"/></label>
        <label>Wobble <input id="bubWobble" type="range" min="0" max="2" step="0.01" value="1"/></label>
        <label>Frequency <input id="bubFreq" type="range" min="0" max="2" step="0.01" value="1"/></label>
        <label>Density <input id="bubDensity" type="range" min="0.25" max="2" step="0.01" value="1"/></label>
      </div>
      <div class="row">
        <label>Alpha <input id="bubAlpha" type="range" min="0" max="1" step="0.01" value="0.95"/></label>
        <label>Min <input id="bubMin" type="number" min="6" max="256" step="1" value="18"/></label>
        <label>Max <input id="bubMax" type="number" min="6" max="256" step="1" value="44"/></label>
        <label>Far <input id="bubFar" type="range" min="0.1" max="0.8" step="0.01" value="0.33"/></label>
      </div>
      <div class="row">
        <label>Size Hz <input id="bubSizeFreq" type="range" min="0" max="1" step="0.01" value="0"/></label>
        <label>Jumbo % <input id="bubJumboChance" type="range" min="0" max="0.5" step="0.01" value="0"/></label>
        <label>Jumbo Scale <input id="bubJumboScale" type="range" min="1.0" max="2.5" step="0.05" value="1.6"/></label>
        <label>Texture
          <select id="bubTex">
            <option value="orb">Orb</option>
            <option value="proc">Procedural</option>
          </select>
        </label>
      </div>

      <div id="iframeHost" style="margin-top:12px; border:1px solid rgba(255,255,255,.12); border-radius:10px; overflow:hidden;">
        <iframe id="targetFrame" title="Target" style="width:100%; height:60vh; display:none; background:#000;"></iframe>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Tips</h3>
      <ul>
        <li>Use ‚ÄúOpen Target with Dev Panel‚Äù to bring up the full overlay on the target page.</li>
        <li>‚ÄúExit Dev Mode‚Äù removes <code>?dev</code> and clears the dev-mode flag.</li>
        <li>Use the phone UI on the target page for temporary exploration; save final values from here.</li>
      </ul>
    </div>
  </div>

  <script>
    (function(){
      const params = new URLSearchParams(location.search);
      const target = params.get('target') || '../../index.html';
      const targetUrl = new URL(target, location.href);

      const $ = (id)=> document.getElementById(id);
      $('targetUrl').textContent = targetUrl.toString();
      $('currentUrl').textContent = location.href;

      function exitDevOn(url){
        try{ localStorage.removeItem('errl-dev-mode'); }catch(e){}
        const u = new URL(url, location.href);
        u.searchParams.delete('dev');
        return u.toString();
      }

      $('backToTarget').href = targetUrl.toString();
      $('openWithDev').onclick = ()=>{
        const u = new URL(targetUrl.toString());
        u.searchParams.set('dev','true');
        window.open(u.toString(), '_blank', 'noopener');
      };
      $('exitDev').onclick = ()=>{
        const url = exitDevOn(targetUrl.toString());
        window.open(url, '_blank', 'noopener');
      };
      $('clearAll').onclick = ()=>{
        try{
          localStorage.removeItem('errl_hue_layers');
          localStorage.removeItem('errl-dev-mode');
          localStorage.removeItem('errl_goo_cfg');
          localStorage.removeItem('errl_nav_goo_cfg');
          localStorage.removeItem('errl_bubbles_fx');
          alert('Cleared saved dev settings.');
        }catch(e){ alert('Could not clear some settings.'); }
      };

      // Live embed controls
      const frame = $('targetFrame');
      function withHue(cb){
        if(!frame || frame.style.display==='none') return;
        const w = frame.contentWindow;
        if(!w) return;
        const apply = ()=>{ if(w.ErrlHueController){ try{ cb(w.ErrlHueController); }catch(e){} } else { setTimeout(apply, 80); } };
        apply();
      }
      function ensureDevSrc(url){
        const u = new URL(url, location.href);
        u.searchParams.set('dev','true');
        return u.toString();
      }
      $('embedTarget').onclick = ()=>{
        frame.onload = ()=>{ try{ $('snapshotState').click(); }catch(e){} };
        frame.src = ensureDevSrc(targetUrl.toString());
        frame.style.display = 'block';
      };
      $('toggleDevPanel').onclick = ()=>{
        if(!frame || frame.style.display==='none') return;
        const d = frame.contentDocument;
        if(!d) return;
        const panel = d.getElementById('devpanel');
        if(panel){ panel.classList.toggle('hidden'); }
      };
      $('iframeExitDev').onclick = ()=>{
        if(!frame || !frame.src) return;
        try{ frame.contentWindow.localStorage.removeItem('errl-dev-mode'); }catch(e){}
        const u = new URL(frame.src);
        u.searchParams.delete('dev');
        frame.src = u.toString();
      };

      // Snapshot and apply state across LS namespaces
      const KEYS = {
        hue: 'errl_hue_layers',
        errlGoo: 'errl_goo_cfg',
        navGoo: 'errl_nav_goo_cfg',
        bubbles: 'errl_bubbles_fx',
      };
      function readLS(key){ try{ const raw=frame.contentWindow.localStorage.getItem(key); return raw? JSON.parse(raw) : null; }catch(e){ return null; } }
      function writeLS(key, obj){ try{ frame.contentWindow.localStorage.setItem(key, JSON.stringify(obj)); }catch(e){} }
      function reloadFrame(){ const src=frame.src; frame.src='about:blank'; setTimeout(()=> frame.src=src, 30); }

      $('snapshotState').onclick = ()=>{
        const api = frame.contentWindow && frame.contentWindow.ErrlLive;
        if(api && api.getState){
          const st = api.getState();
          // Hue for current target
          withHue(ctrl=>{ const tgt=hueTarget.value; const lay = (st && st.hueLayers && st.hueLayers[tgt]) || ctrl.layers[tgt]; if(!lay) return; hueEnabled.checked=!!lay.enabled; hue.value=lay.hue||0; sat.value=lay.saturation??1; inten.value=lay.intensity??1; });
          // Goo
          const eg=st.errlGoo||{}; $('errlGooEnabled').checked=!!eg.enabled; $('errlGooMult').value=eg.mult??1; $('errlGooWobble').value=eg.wobble??1;
          const ng=st.navGoo||{}; $('navGooEnabled').checked=!!ng.enabled; $('navGooBlur').value=ng.blur??6; $('navGooMult').value=ng.mult??24; $('navGooThresh').value=ng.thresh??-14;
          // Bubbles
          const b=st.bubbles||{}; $('bubSpeed').value=b.speed??1; $('bubWobble').value=b.wobble??1; $('bubFreq').value=b.freq??1; $('bubDensity').value=b.density??1; $('bubAlpha').value=b.alpha??0.95; $('bubMin').value=b.min??18; $('bubMax').value=b.max??44; $('bubFar').value=b.far??0.33; $('bubSizeFreq').value=b.sizefreq??0; $('bubJumboChance').value=b.jumbochance??0; $('bubJumboScale').value=b.jumboscale??1.6; $('bubTex').value=b.tex||'orb';
          // Overlay
          const ov=st.overlay||{}; $('glAlphaCtl').value=ov.alpha??0.2; $('glDXCtl').value=ov.dx??24; $('glDYCtl').value=ov.dy??18;
          // Nav Layout
          const nl=st.navLayout||{}; $('navSpreadCtl').value=nl.spread??220; $('navArcCtl').value=nl.arc??120; $('navHeadYCtl').value=nl.headY??0.32; $('navCxCtl').value=nl.cx??-280; $('navStaggerCtl').value=nl.stagger??250;
          return;
        }
        // Fallback to LS if API missing
        withHue(ctrl=>{
          const tgt=hueTarget.value; const lay=ctrl.layers[tgt]; if(!lay) return; hueEnabled.checked=!!lay.enabled; hue.value=lay.hue||0; sat.value=lay.saturation??1; inten.value=lay.intensity??1;
        });
        const goo=readLS(KEYS.errlGoo) || {enabled:true,mult:1,wobble:1}; $('errlGooEnabled').checked=!!goo.enabled; $('errlGooMult').value=goo.mult??1; $('errlGooWobble').value=goo.wobble??1;
        const n=readLS(KEYS.navGoo) || {enabled:true, blur:6, mult:24, thresh:-14}; $('navGooEnabled').checked=!!n.enabled; $('navGooBlur').value=n.blur??6; $('navGooMult').value=n.mult??24; $('navGooThresh').value=n.thresh??-14;
        const b=readLS(KEYS.bubbles) || { speed:1, wobble:1, freq:1, density:1, alpha:0.95, min:18, max:44, far:0.33, sizefreq:0, jumbochance:0, jumboscale:1.6, tex:'orb' }; $('bubSpeed').value=b.speed??1; $('bubWobble').value=b.wobble??1; $('bubFreq').value=b.freq??1; $('bubDensity').value=b.density??1; $('bubAlpha').value=b.alpha??0.95; $('bubMin').value=b.min??18; $('bubMax').value=b.max??44; $('bubFar').value=b.far??0.33; $('bubSizeFreq').value=b.sizefreq??0; $('bubJumboChance').value=b.jumbochance??0; $('bubJumboScale').value=b.jumboscale??1.6; $('bubTex').value=b.tex||'orb';
      };

      $('applyState').onclick = ()=>{
        // Persist Hue (current target only)
        withHue(ctrl=>{
          const tgt=hueTarget.value; const layers=Object.assign({}, ctrl.layers);
          layers[tgt] = Object.assign({}, layers[tgt]||{}, { enabled: !!hueEnabled.checked, hue:+hue.value, saturation:+sat.value, intensity:+inten.value });
          // Save and apply persistently
          try{ frame.contentWindow.localStorage.setItem(KEYS.hue, JSON.stringify(layers)); }catch(e){}
          ctrl.setTarget(tgt);
          ctrl.setEnabled(!!hueEnabled.checked, tgt);
          ctrl.setHue(+hue.value, tgt);
          ctrl.setSaturation(+sat.value, tgt);
          ctrl.setIntensity(+inten.value, tgt);
          if(theme.value) ctrl.applyTheme(tgt, theme.value);
        });
        // Persist Errl Goo
        const goo={ enabled: $('errlGooEnabled').checked, mult:+$('errlGooMult').value, wobble:+$('errlGooWobble').value };
        writeLS(KEYS.errlGoo, goo);
        // Persist Nav Goo
        const ng={ enabled: $('navGooEnabled').checked, blur:+$('navGooBlur').value, mult:+$('navGooMult').value, thresh:+$('navGooThresh').value };
        writeLS(KEYS.navGoo, ng);
        // Persist Bubbles FX
        const bub={ speed:+$('bubSpeed').value, wobble:+$('bubWobble').value, freq:+$('bubFreq').value, density:+$('bubDensity').value, alpha:+$('bubAlpha').value, min:+$('bubMin').value, max:+$('bubMax').value, far:+$('bubFar').value, sizefreq:+$('bubSizeFreq').value, jumbochance:+$('bubJumboChance').value, jumboscale:+$('bubJumboScale').value, tex:$('bubTex').value };
        writeLS(KEYS.bubbles, bub);
        reloadFrame();
      };

      // Hue bindings
      const hueTarget = $('hueTarget');
      const hueEnabled = $('hueEnabled');
      const hue = $('hue');
      const sat = $('sat');
      const inten = $('inten');
      const theme = $('theme');

      function setTarget(){ withHue(ctrl=> ctrl.setTarget(hueTarget.value)); }
      hueTarget.addEventListener('change', setTarget);
      hueEnabled.addEventListener('change', ()=> withHue(ctrl=> ctrl.setEnabled(!!hueEnabled.checked)) );
      hue.addEventListener('input', ()=> withHue(ctrl=> ctrl.setHue(+hue.value)) );
      sat.addEventListener('input', ()=> withHue(ctrl=> ctrl.setSaturation(+sat.value)) );
      inten.addEventListener('input', ()=> withHue(ctrl=> ctrl.setIntensity(+inten.value)) );
      theme.addEventListener('change', ()=> withHue(ctrl=> ctrl.applyTheme(hueTarget.value, theme.value)) );

      // Real-time: GL Overlay
      const gA=$('glAlphaCtl'), gX=$('glDXCtl'), gY=$('glDYCtl');
      function applyOverlay(){ const api=frame.contentWindow && frame.contentWindow.ErrlLive; if(api&&api.setGLOverlay){ api.setGLOverlay({ alpha:+gA.value, dx:+gX.value, dy:+gY.value }); } }
      ;[gA,gX,gY].forEach(el=> el && el.addEventListener('input', applyOverlay));

      // Real-time: Nav Layout
      const nS=$('navSpreadCtl'), nA=$('navArcCtl'), nH=$('navHeadYCtl'), nC=$('navCxCtl'), nTg=$('navStaggerCtl');
      function applyNavLayout(){ const api=frame.contentWindow && frame.contentWindow.ErrlLive; if(api&&api.setNavLayout){ api.setNavLayout({ spread:+nS.value, arc:+nA.value, headY:+nH.value, cx:+nC.value, stagger:+nTg.value }); } }
      ;[nS,nA,nH,nC,nTg].forEach(el=> el && el.addEventListener('input', applyNavLayout));

      // Real-time: Errl Goo
      // (Intentionally omitted; use Apply/Snapshot for persistent changes)
    })();
  </script>
</body>
</html>
