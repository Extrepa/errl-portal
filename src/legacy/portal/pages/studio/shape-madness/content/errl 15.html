<!doctype html>
<html lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Beat-Reactive Spectrum</title>
<style>
:root{ --bg:#050816; --ink:#eaf7ff; --edge:#1b2656 }
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui}
.wrap{min-height:100dvh;display:grid;place-items:center}
.stage{position:relative;width:min(92vw,900px);aspect-ratio:16/10;border:1px solid var(--edge);border-radius:14px;overflow:hidden;background:#040a1c}
canvas{position:absolute;inset:0;width:100%;height:100%}
.ui{position:absolute;left:10px;right:10px;bottom:10px;display:flex;gap:8px;flex-wrap:wrap}
.btn{cursor:pointer;background:#141a3c;border:1px solid #29336b;color:#dff5ff;font-size:12px;padding:6px 10px;border-radius:8px}
.btn:hover{border-color:#46a8ff}
input[type=file]{display:none}
.label{font-size:12px;opacity:.85}
</style></head><body>
<div class="wrap">
  <div class="stage">
    <canvas id="c" width="1200" height="750"></canvas>
    <div class="ui">
      <button class="btn" id="mic">Mic</button>
      <label class="btn" for="file">Load Audio</label><input id="file" type="file" accept="audio/*">
      <span class="label">Beat sensitivity</span>
      <input id="sens" type="range" min="0.6" max="1.3" step="0.01" value="0.95">
    </div>
  </div>
</div>
<script>
const C=document.getElementById('c'), X=C.getContext('2d');
const DPR=Math.max(1,devicePixelRatio||1); C.width*=DPR; C.height*=DPR; X.scale(DPR,DPR);
let W=C.width/DPR, H=C.height/DPR, T=0;

let ctx, src, analyser, dataF, dataT, haveAudio=false, peak=0, lastBeat=0;
const FFT=1024, SMOOTHING=0.85, PEAK_HOLD=180; // frames to hold peak glow
let BEAT_SENSITIVITY=parseFloat(document.getElementById('sens').value); // lower = more sensitive

function grad(t){ const g=X.createConicGradient((t*0.02)%(Math.PI*2), W/2,H/2);
  g.addColorStop(0,"#7cf0ff");g.addColorStop(.33,"#ffd36a");g.addColorStop(.66,"#b07cff");g.addColorStop(1,"#7cf0ff"); return g; }

function initAnalyser(){
  analyser.fftSize=FFT;
  analyser.smoothingTimeConstant=SMOOTHING;
  dataF=new Uint8Array(analyser.frequencyBinCount);
  dataT=new Uint8Array(analyser.fftSize);
  haveAudio=true;
}

document.getElementById('mic').onclick=async()=>{
  try{
    ctx=new (window.AudioContext||window.webkitAudioContext)();
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    src=ctx.createMediaStreamSource(stream);
    analyser=ctx.createAnalyser(); src.connect(analyser);
    initAnalyser();
  }catch(e){ alert("Mic denied."); }
};

document.getElementById('file').onchange=async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  ctx=new (window.AudioContext||window.webkitAudioContext)();
  const buf=await f.arrayBuffer(); const audiobuf=await ctx.decodeAudioData(buf);
  const bsrc=ctx.createBufferSource(); bsrc.buffer=audiobuf; bsrc.loop=true;
  analyser=ctx.createAnalyser(); bsrc.connect(analyser); analyser.connect(ctx.destination); bsrc.start();
  initAnalyser();
};

document.getElementById('sens').oninput=(e)=>{ BEAT_SENSITIVITY=parseFloat(e.target.value); };

function beatDetect(){
  // Energy-based: compare current low-band energy to rolling average.
  if(!haveAudio) return false;
  analyser.getByteFrequencyData(dataF);
  let low=0, n=Math.max(8,Math.floor(dataF.length*0.12));
  for(let i=0;i<n;i++) low+=dataF[i];
  low/=n; // 0..255
  // Exponential moving average baseline:
  beatDetect.avg = (beatDetect.avg??low)*0.92 + low*0.08;
  const rel = low / (beatDetect.avg+1e-3);
  const isBeat = rel > BEAT_SENSITIVITY && (performance.now()-lastBeat>120);
  if(isBeat) lastBeat=performance.now();
  // update peak
  peak = Math.max(peak*0.96, isBeat ? 1 : peak*0.98);
  return isBeat;
}

function draw(){
  T++;
  X.fillStyle="rgba(5,8,22,0.08)"; X.fillRect(0,0,W,H);

  // bars
  if(haveAudio) analyser.getByteFrequencyData(dataF);
  const N=dataF?dataF.length:128;
  const bw = (W*0.9)/N, ox = W*0.05, oy=H*0.75;
  for(let i=0;i<N;i++){
    const v = dataF? dataF[i]/255 : (0.4+0.3*Math.sin((T+i)*0.03));
    const h = v*(H*0.6);
    X.fillStyle=`hsl(${(i/N*360+T*0.2)%360} 95% 65%)`;
    X.fillRect(ox+i*bw, oy-h, Math.max(1,bw*0.8), h);
  }

  // halo pulse on beats
  const beat = beatDetect();
  const glow = Math.max(0, 1 - (performance.now()-lastBeat)/PEAK_HOLD);
  if(glow>0){
    X.save(); X.filter=`blur(${12+40*glow}px) saturate(${1.1+glow*0.6})`; X.fillStyle=grad(T);
    X.beginPath(); X.arc(W/2,H*0.3, 80+120*glow, 0, Math.PI*2); X.fill(); X.restore();
  }
  // static ring overlay
  X.lineWidth= 20 + 8*glow; X.strokeStyle=grad(T+30);
  X.beginPath(); X.arc(W/2,H*0.3, 120, 0, Math.PI*2); X.stroke();

  requestAnimationFrame(draw);
}
draw();
</script>
</body></html>