<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gravity Sticker Field | Errl</title>
<style>
  :root { --reduced-motion: 0; }
  html,body{
    height:100%;
    margin:0;
    background:#0a0a10;
    color:#fff;
    font-family:ui-sans-serif,system-ui,sans-serif;
    overflow:hidden;
  }
  canvas{
    position:fixed;
    inset:0;
    touch-action:none;
  }
  .ui{
    position:fixed;
    bottom:1rem;
    left:50%;
    transform:translateX(-50%);
    background:#0006;
    padding:.5rem .9rem;
    border-radius:10px;
    border:1px solid #fff2;
    pointer-events:none;
    user-select:none;
  }
</style>
</head>
<body>
<canvas id="c"></canvas>
<div class="ui">Drag stickers • They fall &amp; collide • Errl</div>
<script>
// Inline utilities
function isReducedMotion() {
  return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
}
function onReducedMotionChange(cb) {
  const mq = window.matchMedia('(prefers-reduced-motion: reduce)');
  const handler = (e) => cb(e.matches);
  if (mq.addEventListener) {
    mq.addEventListener('change', handler);
    return () => mq.removeEventListener('change', handler);
  } else {
    mq.addListener(handler);
    return () => mq.removeListener(handler);
  }
}
function setCanvasSize(canvas, w, h, dpr = devicePixelRatio || 1) {
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  const ctx = canvas.getContext('2d');
  if (ctx) ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
function clamp(n, min, max) {
  return Math.max(min, Math.min(max, n));
}

const cvs = document.getElementById('c');
const ctx = cvs.getContext('2d');
let reduced = isReducedMotion();
onReducedMotionChange(val => { reduced = val; init(); });

// Physics constants
const GRAV = 0.5;
const REST = 0.8;
const FRICTION = 0.99;
const R = 28;

// Sticker image (placeholder circle if not loaded)
const img = new Image();
// Inline data URL for single-file (replace with your own or reference external sticker.png)
img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="56" height="56"%3E%3Ccircle cx="28" cy="28" r="26" fill="%23f0a" stroke="%23fff" stroke-width="2"/%3E%3C/svg%3E';

let balls = [];
let N = reduced ? 8 : 14;
let paused = false;
let mx = 0, my = 0, md = false, dragI = -1, ox = 0, oy = 0;

function init() {
  N = reduced ? 8 : 14;
  balls = Array.from({ length: N }, (_, i) => ({
    x: 100 + i * 50,
    y: 80,
    vx: 0,
    vy: 0,
    r: R,
    drag: false
  }));
}

function fit() {
  setCanvasSize(cvs, innerWidth, innerHeight);
}
fit();
addEventListener('resize', fit);
init();

// Pointer interaction
addEventListener('pointerdown', (e) => {
  md = true;
  mx = e.clientX;
  my = e.clientY;
  dragI = balls.findIndex(b => (mx - b.x) ** 2 + (my - b.y) ** 2 < b.r * b.r);
  if (dragI >= 0) {
    balls[dragI].drag = true;
    ox = mx - balls[dragI].x;
    oy = my - balls[dragI].y;
  }
});
addEventListener('pointermove', (e) => {
  mx = e.clientX;
  my = e.clientY;
});
addEventListener('pointerup', () => {
  md = false;
  if (dragI >= 0) {
    balls[dragI].drag = false;
    dragI = -1;
  }
});

// Pause/resume on visibility
document.addEventListener('visibilitychange', () => {
  paused = document.hidden;
});

function step() {
  if (paused || (reduced && dragI < 0)) return;
  
  const gravStrength = reduced ? GRAV * 0.3 : GRAV;
  
  for (let i = 0; i < balls.length; i++) {
    const b = balls[i];
    if (b.drag) {
      b.x = mx - ox;
      b.y = my - oy;
      b.vx *= 0.8;
      b.vy *= 0.8;
    } else {
      b.vy += gravStrength;
      b.vx *= FRICTION;
      b.vy *= FRICTION;
      b.x += b.vx;
      b.y += b.vy;
    }
    // Walls
    if (b.x - b.r < 0) { b.x = b.r; b.vx *= -REST; }
    if (b.x + b.r > innerWidth) { b.x = innerWidth - b.r; b.vx *= -REST; }
    if (b.y + b.r > innerHeight) { b.y = innerHeight - b.r; b.vy *= -REST; }
    if (b.y - b.r < 0) { b.y = b.r; b.vy *= -REST; }
  }
  
  // Collisions
  for (let i = 0; i < balls.length; i++) {
    for (let j = i + 1; j < balls.length; j++) {
      const a = balls[i], b = balls[j];
      const dx = b.x - a.x, dy = b.y - a.y;
      const dist = Math.hypot(dx, dy);
      const min = a.r + b.r;
      if (dist > 0 && dist < min) {
        const nx = dx / dist, ny = dy / dist;
        const pen = min - dist;
        a.x -= nx * pen * 0.5;
        a.y -= ny * pen * 0.5;
        b.x += nx * pen * 0.5;
        b.y += ny * pen * 0.5;
        const rvx = b.vx - a.vx, rvy = b.vy - a.vy;
        const rel = rvx * nx + rvy * ny;
        const imp = -(1 + REST) * rel * 0.5;
        a.vx -= imp * nx;
        a.vy -= imp * ny;
        b.vx += imp * nx;
        b.vy += imp * ny;
      }
    }
  }
}

function draw() {
  ctx.clearRect(0, 0, innerWidth, innerHeight);
  for (const b of balls) {
    if (img.complete && img.naturalWidth > 0) {
      ctx.drawImage(img, b.x - b.r, b.y - b.r, b.r * 2, b.r * 2);
    } else {
      ctx.fillStyle = '#f0a';
      ctx.beginPath();
      ctx.arc(b.x, b.y, b.r, 0, 6.283);
      ctx.fill();
    }
  }
}

(function loop() {
  requestAnimationFrame(loop);
  step();
  draw();
})();
</script>
</body>
</html>
