<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Component Rips Catalog</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #0d1018;
        --panel: #151b27;
        --border: #1f2735;
        --accent: #5ac0ff;
        --text: #f0f4ff;
        --muted: #9ca6bc;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: radial-gradient(circle at top, #10192b, #07090d 65%);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      header {
        padding: 24px clamp(24px, 6vw, 64px) 16px;
        text-align: center;
      }
      header h1 {
        margin: 0 0 12px;
        font-size: clamp(28px, 5vw, 44px);
      }
      header p {
        margin: 4px auto;
        color: var(--muted);
        max-width: 720px;
      }
      main {
        flex: 1;
        padding: 0 clamp(24px, 6vw, 64px) 64px;
        display: flex;
        flex-direction: column;
        gap: 28px;
      }
      .filter-bar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        background: rgba(14, 20, 32, 0.7);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px 16px;
      }
      .category-tabs {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .category-tab {
        background: rgba(8, 12, 22, 0.9);
        border: 1px solid rgba(90, 192, 255, 0.25);
        border-radius: 999px;
        color: var(--text);
        padding: 6px 14px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
      }
      .category-tab:hover {
        border-color: rgba(90, 192, 255, 0.4);
        background: rgba(12, 18, 30, 0.95);
      }
      .category-tab.active {
        background: linear-gradient(135deg, rgba(90, 192, 255, 0.35), rgba(106, 255, 205, 0.45));
        border-color: rgba(90, 192, 255, 0.5);
        color: #041022;
        font-weight: 600;
      }
      .grid {
        display: grid;
        gap: 24px;
        grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 20px;
        display: grid;
        gap: 14px;
        box-shadow: 0 24px 56px -32px rgba(6, 12, 32, 0.75);
        position: relative;
        transition: border-color 0.2s ease, transform 0.2s ease;
        overflow: hidden;
      }
      .card.copied::after {
        content: "Copied!";
        position: absolute;
        top: 12px;
        right: 18px;
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--accent);
      }
      .card:hover {
        border-color: rgba(90, 192, 255, 0.45);
        transform: translateY(-2px);
      }
      .card header {
        padding: 8px 12px 4px;
        display: flex;
        align-items: flex-start;
        gap: 16px;
      }
      .card header h2 {
        margin: 0;
        padding: 0;
        font-size: 20px;
        line-height: 1.25;
        flex: 1 1 auto;
        min-width: 0;
        text-align: left;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .card header .meta-col {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
        flex-shrink: 0;
        min-width: 120px;
      }
      .card .category {
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-size: 11px;
        font-weight: 600;
      }
      /* Category-specific colors matching card borders */
      .card.category-cursor .category {
        color: rgba(154, 255, 241, 0.9);
      }
      .card.category-prop .category {
        color: rgba(255, 154, 241, 0.9);
      }
      .card.category-button .category {
        color: rgba(255, 200, 100, 0.9);
      }
      .card.category-background .category {
        color: rgba(106, 255, 205, 0.9);
      }
      .card.category-text .category {
        color: rgba(170, 160, 255, 0.9);
      }
      .card.category-module .category {
        color: rgba(90, 192, 255, 0.9);
      }
      .card.category-misc .category {
        color: rgba(200, 200, 200, 0.9);
      }
      /* Category-based card colors */
      .card.category-cursor {
        border-color: rgba(154, 255, 241, 0.3);
      }
      .card.category-cursor:hover {
        border-color: rgba(154, 255, 241, 0.5);
      }
      .card.category-prop {
        border-color: rgba(255, 154, 241, 0.3);
      }
      .card.category-prop:hover {
        border-color: rgba(255, 154, 241, 0.5);
      }
      .card.category-button {
        border-color: rgba(255, 200, 100, 0.3);
      }
      .card.category-button:hover {
        border-color: rgba(255, 200, 100, 0.5);
      }
      .card.category-background {
        border-color: rgba(106, 255, 205, 0.3);
      }
      .card.category-background:hover {
        border-color: rgba(106, 255, 205, 0.5);
      }
      .card.category-text {
        border-color: rgba(170, 160, 255, 0.3);
      }
      .card.category-text:hover {
        border-color: rgba(170, 160, 255, 0.5);
      }
      .card.category-module {
        border-color: rgba(90, 192, 255, 0.3);
      }
      .card.category-module:hover {
        border-color: rgba(90, 192, 255, 0.5);
      }
      .card.category-misc {
        border-color: rgba(200, 200, 200, 0.3);
      }
      .card.category-misc:hover {
        border-color: rgba(200, 200, 200, 0.5);
      }
      .status {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(90, 192, 255, 0.3);
        color: var(--accent);
        font-size: 11px;
        font-weight: 600;
        line-height: 1;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
      }
      .status-normalized {
        background: rgba(106, 255, 205, 0.15);
        border-color: rgba(106, 255, 205, 0.4);
        color: #6affcd;
      }
      .status-gate {
        background: rgba(255, 170, 87, 0.18);
        border-color: rgba(255, 170, 87, 0.4);
        color: #ffbb73;
      }
      .status-queued {
        background: rgba(90, 192, 255, 0.18);
      }
      .status-scaffold {
        background: rgba(180, 160, 255, 0.18);
      }
      .status-raw {
        background: rgba(120, 140, 180, 0.18);
      }
      .status-demo-ready {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.35);
        color: #ffffff;
      }
      .status-integrated {
        background: rgba(110, 255, 170, 0.2);
        border-color: rgba(110, 255, 170, 0.5);
        color: #0f2618;
      }
      .description {
        margin: 0 0 6px 0;
        color: var(--muted);
        line-height: 1.5;
        font-size: 14px;
      }
      .meta {
        display: grid;
        gap: 12px;
        font-size: 12px;
      }
      .meta .label {
        display: block;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 11px;
        color: rgba(157, 176, 211, 0.7);
        margin-bottom: 4px;
      }
      .meta code {
        display: inline-block;
        background: rgba(10, 16, 28, 0.9);
        border-radius: 8px;
        padding: 4px 8px;
        border: 1px solid rgba(90, 192, 255, 0.16);
      }
      .controls {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 6px 8px;
      }
      .controls li {
        background: rgba(8, 12, 22, 0.7);
        border-radius: 8px;
        border: 1px solid rgba(90, 192, 255, 0.18);
        padding: 4px 8px;
      }
      .safety {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .safety li {
        background: rgba(28, 34, 48, 0.7);
        border-radius: 8px;
        border: 1px solid rgba(120, 160, 220, 0.18);
        padding: 4px 8px;
        font-size: 12px;
        color: rgba(200, 210, 240, 0.85);
      }
      .open-demo-btn {
        width: 40px;
        height: 40px;
        min-width: 40px;
        min-height: 40px;
        border-radius: 50%;
        padding: 0;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        border: 1px solid rgba(90, 192, 255, 0.25);
        background: linear-gradient(135deg, rgba(90, 192, 255, 0.35), rgba(106, 255, 205, 0.45));
        color: #041022;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: border-color 0.2s ease, transform 0.2s ease;
        line-height: 1;
        gap: 2px;
        margin-left: auto;
      }
      .open-demo-btn:hover {
        border-color: rgba(90, 192, 255, 0.5);
        transform: scale(1.05);
      }
      .open-demo-btn .arrow {
        font-size: 16px;
      }
      .open-demo-btn .text {
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .empty,
      .error {
        margin: 0;
        padding: 32px;
        text-align: center;
        border: 1px dashed rgba(90, 192, 255, 0.25);
        border-radius: 18px;
        color: rgba(200, 212, 240, 0.8);
        background: rgba(11, 16, 28, 0.6);
      }
      footer {
        padding: 24px clamp(24px, 6vw, 64px);
        color: var(--muted);
        font-size: 13px;
      }
      .placeholder {
        text-transform: uppercase;
        letter-spacing: 0.14em;
        font-size: 11px;
        color: rgba(154, 176, 210, 0.6);
      }
      
      /* Preview Container */
      .preview-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        background: linear-gradient(135deg, #0f141d, #0a0c12);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(90, 192, 255, 0.15);
        margin: 4px 0;
        cursor: pointer;
        transition: border-color 0.2s ease, transform 0.2s ease;
      }
      .preview-container:hover {
        border-color: rgba(90, 192, 255, 0.4);
        transform: translateY(-2px);
        cursor: default;
      }
      
      .preview-thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        opacity: 1;
        transition: opacity 0.3s ease;
      }
      
      .preview-iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 200%;
        height: 200%;
        border: none;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        transform: scale(0.5);
        transform-origin: top left;
      }
      .preview-container:hover .preview-iframe {
        opacity: 1;
        pointer-events: auto;
      }
      .preview-container:hover .preview-thumbnail {
        opacity: 0;
      }
      
      /* Meta and controls sections - prevent overflow */
      .meta {
        max-width: 100%;
        overflow: hidden;
      }
      .meta > div {
        max-width: 100%;
        overflow: hidden;
      }
      .meta code {
        display: inline;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        word-break: break-all;
      }
      .source-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        color: var(--accent);
        text-decoration: none;
        font-size: 13px;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid rgba(90, 192, 255, 0.25);
        background: rgba(10, 16, 28, 0.6);
        transition: all 0.2s ease;
      }
      .source-link:hover {
        background: rgba(90, 192, 255, 0.15);
        border-color: rgba(90, 192, 255, 0.4);
      }
      button.source-link {
        display: block;
        width: 100%;
        text-align: left;
      }
      button.source-link:hover {
        background: rgba(90, 192, 255, 0.15);
        border-color: rgba(90, 192, 255, 0.4);
      }
      .control-desc {
        color: var(--muted);
        font-size: 12px;
        font-weight: normal;
        font-style: italic;
      }
      .controls,
      .safety {
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .controls li {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .safety li {
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        font-size: 12px;
        line-height: 1.4;
      }
      .safety li:first-child {
        font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
        font-size: 11px;
        color: var(--muted);
        letter-spacing: 0.05em;
      }
      
      .meta-row {
        display: flex;
        gap: 16px;
        align-items: flex-start;
        margin-bottom: 12px;
      }
      
      .meta-row > div {
        flex: 1;
      }
      
      .preview-placeholder {
        position: absolute;
        inset: 0;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #0f141d, #0a0c12);
        color: rgba(154, 176, 210, 0.6);
        font-size: 12px;
        gap: 8px;
      }
      .preview-placeholder::before {
        content: "ðŸ“¸";
        font-size: 32px;
        opacity: 0.5;
      }
      .preview-hint {
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 11px;
        margin-top: 8px;
      }
      .preview-container:hover .preview-placeholder {
        opacity: 0;
      }
      
      .preview-loading {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(10, 12, 18, 0.9);
        color: var(--accent);
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .preview-loading.active {
        opacity: 1;
      }
      
      @media (max-width: 720px) {
        main {
          grid-template-columns: 1fr;
        }
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Component Rips Catalog</h1>
      <p>
        Live manifest of assets sourced from <code>archive/component-rips-20251112/Component_Rips</code>. Entries update when
        `packages/component-rips/*/meta.json` changes. Use filters to focus by category or status.
        <br>
        <small style="opacity: 0.7;">Hover over thumbnails to see live previews. Generate thumbnails with <code>npm run thumbnails:generate</code></small>
      </p>
    </header>
    <main id="catalog" aria-live="polite"></main>
    <footer>
      Status legend: raw â†’ untouched export Â· queued â†’ assigned for conversion Â· scaffold â†’ bundle seeded Â· gate â†’ requires
      safety controls Â· normalized â†’ project-ready Â· demo-ready â†’ catalog embed wired Â· integrated â†’ live in portal/studio.
    </footer>
    <script type="module">
      const catalogEl = document.getElementById("catalog");
      const manifestUrl = new URL("./manifest.json", window.location.href);

      const statusPriority = ["integrated", "demo-ready", "normalized", "gate", "scaffold", "queued", "raw"];
      const statusLabels = {
        raw: "Raw",
        queued: "Queued",
        scaffold: "Scaffold",
        gate: "Gate",
        normalized: "Normalized",
        "demo-ready": "Demo Ready",
        integrated: "Integrated",
      };

      function createFilterBar(categories) {
        const wrapper = document.createElement("div");
        wrapper.className = "filter-bar";

        const tabsContainer = document.createElement("div");
        tabsContainer.className = "category-tabs";

        // Create "All" tab first
        const allTab = document.createElement("button");
        allTab.className = "category-tab active";
        allTab.textContent = "All";
        allTab.dataset.category = "";
        tabsContainer.appendChild(allTab);

        // Create tabs for each category
        const categoryKeys = Object.keys(categories).sort();
        categoryKeys.forEach((category) => {
          const tab = document.createElement("button");
          tab.className = "category-tab";
          tab.textContent = category.charAt(0).toUpperCase() + category.slice(1);
          tab.dataset.category = category;
          tabsContainer.appendChild(tab);
        });

        wrapper.appendChild(tabsContainer);
        return { wrapper, tabsContainer };
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (text == null) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
      }

      // Escape for HTML attribute values (only quotes and ampersands, not URL characters)
      function escapeAttr(text) {
        if (text == null) return '';
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;');
      }

      function renderCards(packages, filters) {
        const container = document.createElement("div");
        container.className = "grid";

        packages.forEach((pkg) => {
          if (filters.category && pkg.category !== filters.category) return;
          if (filters.status && pkg.status !== filters.status) return;

          const card = document.createElement("article");
          card.className = `card category-${pkg.category}`;

          const safety = pkg.safety ?? {};
          // Condense safety info into one line (safe - no user input)
          const safetyLine = `Audio: ${safety.audio ? "opt-in" : "none"} | Video: ${safety.video ? "opt-in" : "none"} | Camera: ${safety.camera ? "opt-in" : "none"}`;
          const safetySummaries = [safetyLine];
          if (safety.notes) safetySummaries.push(escapeHtml(safety.notes));
          
          // Generate control descriptions
          const getControlDescription = (control) => {
            const label = escapeHtml(control.label || control.id);
            const type = control.type || 'control';
            const min = control.min !== undefined ? control.min : '';
            const max = control.max !== undefined ? control.max : '';
            const step = control.step !== undefined ? control.step : '';
            
            let desc = '';
            if (type === 'range') {
              desc = `Adjust ${label.toLowerCase()}`;
              if (min !== '' && max !== '') {
                desc += ` from ${min} to ${max}`;
                if (step && step !== 1) desc += ` (step: ${step})`;
              }
            } else if (type === 'button') {
              desc = `Click to ${label.toLowerCase().replace('enable ', '').replace('toggle ', '').replace('activate ', '')}`;
            } else if (type === 'text' || type === 'input') {
              desc = `Enter ${label.toLowerCase()}`;
            } else {
              desc = `${label} control`;
            }
            return desc;
          };

          // Determine preview type based on category
          const previewType = ['cursor', 'background', 'prop'].includes(pkg.category) ? 'simple' :
                             ['module', 'text'].includes(pkg.category) ? 'medium' : 'complex';
          
          // Escape all user-controlled data
          const safeSlug = escapeHtml(pkg.slug);
          const safeName = escapeHtml(pkg.name);
          const safeDescription = escapeHtml(pkg.description);
          const safeCategory = escapeHtml(pkg.category);
          const safeStatus = escapeHtml(pkg.status);
          const safeSource = escapeHtml(pkg.source);
          // Don't HTML-escape URLs - they need to remain valid URLs
          // Use the raw preview index or construct it from the slug
          const rawPreviewIndex = pkg.preview?.index || `../../../packages/component-rips/${pkg.slug}/index.html`;
          
          // Thumbnail path (slug is already escaped for HTML content)
          const thumbnailPath = `../../../packages/component-rips/_thumbnails/${safeSlug}.png`;
          // Add preview=1 param to hide controls in preview mode
          // Check for ? in the raw URL before any escaping
          const previewUrl = rawPreviewIndex + (rawPreviewIndex.includes('?') ? '&' : '?') + 'preview=1';
          // Escape the URL only for use in HTML attributes (quotes and ampersands)
          const safePreviewUrl = escapeAttr(previewUrl);

          card.innerHTML = `
            <header>
              <h2>${safeName}</h2>
              <div class="meta-col">
                <p class="category">${safeCategory}</p>
                <span class="status status-${safeStatus}">${escapeHtml(statusLabels[pkg.status] ?? safeStatus)}</span>
              </div>
            </header>
            <div class="preview-container" data-preview-type="${previewType}" data-preview-url="${safePreviewUrl}">
              <img class="preview-thumbnail" src="${thumbnailPath}" alt="${safeName} preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div class="preview-placeholder">
                <span class="preview-hint">No thumbnail</span>
                <span class="preview-hint">Hover to preview</span>
              </div>
              <iframe 
                class="preview-iframe" 
                data-src="${safePreviewUrl}"
                loading="lazy"
                sandbox="allow-scripts allow-same-origin"
                title="${safeName} preview"
                style="overflow: hidden;"
              ></iframe>
              <div class="preview-loading">Loading preview...</div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px; padding: 0 4px;">
              <p class="description" style="flex: 1; margin: 0;">${safeDescription}</p>
              <a href="${escapeAttr(rawPreviewIndex)}" target="_blank" rel="noopener" class="open-demo-btn" title="Open Demo">
                <span class="arrow">â†’</span>
                <span class="text">demo</span>
              </a>
            </div>
            <div class="meta">
              <div class="meta-row">
                <div>
                  <span class="label">Source</span>
                  <a href="../../../${safeSource}" target="_blank" rel="noopener" class="source-link">
                    Go to Source â†’
                  </a>
                </div>
                <div>
                  <span class="label">Import</span>
                  <button data-copy="${safeSlug}" class="source-link">
                    Copy Import Path â†’
                  </button>
                </div>
              </div>
              <div>
                <span class="label">Controls</span>
                <ul class="controls">
                  ${
                    (pkg.controls ?? [])
                      .map((control) => {
                        const safeLabel = escapeHtml(control.label ?? control.id);
                        const desc = getControlDescription(control);
                        return `<li><code>${safeLabel}</code> <span class="control-desc">â€” ${desc}</span></li>`;
                      })
                      .join("") || "<li>None</li>"
                  }
                </ul>
              </div>
              <div>
                <span class="label">Safety</span>
                <ul class="safety">
                  ${safetySummaries.map((line) => `<li>${line}</li>`).join("")}
                </ul>
              </div>
            </div>
          `;

          card.querySelector("button[data-copy]").addEventListener("click", async () => {
            const text = pkg.preview.index;
            if (navigator.clipboard?.writeText) {
              await navigator.clipboard.writeText(text);
            } else {
              const temp = document.createElement("textarea");
              temp.value = text;
              temp.setAttribute("readonly", "");
              temp.style.position = "absolute";
              temp.style.left = "-9999px";
              document.body.appendChild(temp);
              temp.select();
              document.execCommand("copy");
              document.body.removeChild(temp);
            }
            card.classList.add("copied");
            setTimeout(() => card.classList.remove("copied"), 900);
          });

          // Setup preview hover loading
          const previewContainer = card.querySelector('.preview-container');
          const previewIframe = card.querySelector('.preview-iframe');
          const previewLoading = card.querySelector('.preview-loading');
          let previewLoaded = false;
          let hoverTimeout = null;

          previewContainer.addEventListener('mouseenter', () => {
            if (previewLoaded || previewType === 'complex') return;
            
            hoverTimeout = setTimeout(() => {
              if (!previewIframe.src) {
                previewLoading.classList.add('active');
                previewIframe.src = previewIframe.dataset.src;
                previewIframe.onload = () => {
                  previewLoading.classList.remove('active');
                  previewLoaded = true;
                  
                  // Hide controls in preview iframe
                  try {
                    const iframeDoc = previewIframe.contentDocument || previewIframe.contentWindow.document;
                    const style = iframeDoc.createElement('style');
                    style.textContent = `
                      .controls,
                      #controls {
                        display: none !important;
                      }
                    `;
                    iframeDoc.head.appendChild(style);
                  } catch (e) {
                    // Cross-origin or other error - controls may still show, that's okay
                  }
                };
                previewIframe.onerror = () => {
                  previewLoading.classList.remove('active');
                  previewContainer.querySelector('.preview-placeholder').style.display = 'flex';
                };
              }
            }, previewType === 'simple' ? 100 : 300);
          });

          previewContainer.addEventListener('mouseleave', () => {
            if (hoverTimeout) {
              clearTimeout(hoverTimeout);
              hoverTimeout = null;
            }
            
            // Reset preview state by reloading iframe
            if (previewLoaded && previewIframe.src) {
              const currentSrc = previewIframe.src;
              previewIframe.src = '';
              // Small delay to ensure clean reset
              setTimeout(() => {
                if (previewContainer.matches(':hover')) {
                  // Mouse came back, don't reset
                  return;
                }
                previewIframe.src = currentSrc;
                previewLoaded = false;
              }, 50);
            }
          });

          // Click preview to open full demo (only if clicking on container/thumbnail, not iframe)
          previewContainer.addEventListener('click', (e) => {
            // Don't open demo if clicking on the iframe itself (let it be interactive)
            if (e.target === previewIframe || e.target.closest('.preview-iframe')) {
              return;
            }
            if (e.target === previewContainer || e.target.classList.contains('preview-thumbnail') || e.target.classList.contains('preview-placeholder')) {
              window.open(previewUrl, '_blank', 'noopener');
            }
          });

          container.appendChild(card);
        });

        if (!container.childElementCount) {
          const empty = document.createElement("p");
          empty.className = "empty";
          empty.textContent = "No components match the current filters.";
          return empty;
        }

        return container;
      }

      function loadManifest(url) {
        return new Promise((resolve, reject) => {
          // Try fetch first (works with http/https)
          if (window.location.protocol === "http:" || window.location.protocol === "https:") {
            fetch(url, { cache: "no-store" })
              .then((response) => {
                if (!response.ok) throw new Error(`${response.status} ${response.statusText}`);
                return response.json();
              })
              .then(resolve)
              .catch(reject);
          } else {
            // Fallback to XMLHttpRequest for file:// protocol
            const xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onload = () => {
              if (xhr.status === 0 || xhr.status === 200) {
                try {
                  resolve(JSON.parse(xhr.responseText));
                } catch (e) {
                  reject(new Error(`Failed to parse manifest: ${e.message}`));
                }
              } else {
                reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
              }
            };
            xhr.onerror = () => {
              reject(new Error(`Cannot load manifest from file:// protocol. Please use a local server:<br><br><code>cd docs/catalog/component-rips && python3 -m http.server 8000</code><br><br>Then open <code>http://localhost:8000</code> in your browser.`));
            };
            xhr.send();
          }
        });
      }

      async function bootstrap() {
        catalogEl.textContent = "Loading manifestâ€¦";
        try {
          const manifest = await loadManifest(manifestUrl);

          catalogEl.textContent = "";
          const { wrapper, tabsContainer } = createFilterBar(manifest.categories);
          catalogEl.appendChild(wrapper);

          let currentCategory = "";
          const categoryKeys = Object.keys(manifest.categories).sort();
          if (categoryKeys.length > 0) {
            // Default to first category (not "All")
            currentCategory = categoryKeys[0];
            // Update active tab
            tabsContainer.querySelectorAll('.category-tab').forEach(tab => {
              if (tab.dataset.category === currentCategory) {
                tab.classList.add('active');
              } else {
                tab.classList.remove('active');
              }
            });
          }

          const render = () => {
            catalogEl.querySelectorAll(".grid, .empty").forEach((el) => el.remove());
            const filters = { category: currentCategory, status: "" };
            const cards = renderCards(manifest.packages, filters);
            catalogEl.appendChild(cards);
          };

          // Add click handlers to tabs
          tabsContainer.querySelectorAll('.category-tab').forEach(tab => {
            tab.addEventListener('click', () => {
              // Update active state
              tabsContainer.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
              // Update current category
              currentCategory = tab.dataset.category || "";
              render();
            });
          });

          render();
        } catch (error) {
          catalogEl.innerHTML = `<div class="error"><p>Failed to load manifest:</p><p>${error.message}</p></div>`;
        }
      }

      bootstrap();
    </script>
  </body>
</html>
